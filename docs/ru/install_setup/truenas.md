# Настройка TrueNAS

Этот гид объясняет, как настроить Gramps Web на TrueNAS Community Edition 25.04.

!!! warning
    Этот гид предназначен для TrueNAS Community Edition 25.04 или более поздних версий, которые представили новую систему приложений на основе Docker Compose. Он не применим к более ранним версиям TrueNAS.

## Предварительные требования

- TrueNAS Community Edition 25.04 или более поздняя версия
- Базовое знакомство с веб-интерфейсом TrueNAS
- Набор данных для хранения данных Gramps Web

## Обзор

TrueNAS Community Edition 25.04 представил новую систему приложений на основе Docker Compose, которая заменяет предыдущий подход на основе Helm chart. Этот гид проведет вас через создание пользовательского приложения для Gramps Web с использованием Docker Compose.

## Шаг 1: Подготовка хранилища

1. Перейдите в **Datasets** в веб-интерфейсе TrueNAS
2. Создайте новый набор данных для Gramps Web (например, `grampsweb`). Обратите внимание на полный путь к этому набору данных, например, `/mnt/storage/grampsweb`, так как он понадобится вам позже.

Создайте подкаталоги для различных компонентов:
- `users` - База данных пользователей
- `database` - Файл(ы) базы данных Gramps
- `media` - Медиафайлы

## Шаг 2: Создание приложения Docker Compose

1. Перейдите в **Apps** в веб-интерфейсе TrueNAS
2. Нажмите на **Discover Apps**
3. Найдите "Gramps Web" и нажмите на него
4. Нажмите "Install"

Это перенаправит вас на страницу конфигурации приложения.

## Шаг 3: Настройка приложения

### Конфигурация Gramps Web

- **Часовой пояс:** Установите на ваш местный часовой пояс (например, `Europe/Berlin`)
- **Пароль Redis:** Установите пароль для Redis. Он будет использоваться только внутри приложения.
- **Отключить телеметрию:** пожалуйста, оставьте этот флажок не отмеченным – смотрите [здесь для деталей](telemetry.md).
- **Секретный ключ:** крайне важно установить это значение на сильное, уникальное. Смотрите [конфигурацию сервера](configuration.md#existing-configuration-settings) для инструкций о том, как сгенерировать случайный ключ.
- **Дополнительные переменные окружения:** Вам нужно будет установить все дополнительные [опции конфигурации](configuration.md) в качестве переменных окружения с префиксом `GRAMPSWEB_`. Пожалуйста, внимательно ознакомьтесь с [документацией по конфигурации](configuration.md) – например, с тем фактом, что булевы значения должны быть установлены как `true` или `false` (все строчные буквы) в случае переменных окружения, что является распространенной ошибкой.

Пожалуйста, **по крайней мере** установите `GRAMPSWEB_BASE_URL` на URL, по которому будет доступен ваш экземпляр Gramps Web – это необходимо для правильной работы.

Вы также можете настроить конфигурацию электронной почты на этом этапе. Если вы это сделаете, вы можете пропустить шаг конфигурации электронной почты в мастере настройки. Соответствующие переменные окружения:

- `GRAMPSWEB_EMAIL_HOST`
- `GRAMPSWEB_EMAIL_HOST_USER`
- `GRAMPSWEB_EMAIL_HOST_PASSWORD`
- `GRAMPSWEB_DEFAULT_FROM_EMAIL`

Все настройки конфигурации могут быть изменены позже, нажав "Edit" в интерфейсе приложений TrueNAS.

### Конфигурация хранилища

- **Хранилище пользователей:** Выберите путь к каталогу `users`, который вы создали ранее.
- **Хранилище индекса:** Вы можете оставить значение по умолчанию "ixVolume (Набор данных, созданный автоматически системой)"
- **Хранилище кэша миниатюр:** Вы можете оставить значение по умолчанию "ixVolume (Набор данных, созданный автоматически системой)"
- **Хранилище кэша:** Вы можете оставить значение по умолчанию "ixVolume (Набор данных, созданный автоматически системой)"
- **Хранилище медиа:** Выберите путь к каталогу `media`, который вы создали ранее.
- **Хранилище базы данных Gramps:** Выберите путь к каталогу `database`, который вы создали ранее.

### Конфигурация ресурсов

Рекомендуем выделить как минимум 2 ЦП и 4096 МБ ОЗУ для обеспечения плавной работы.

## Шаг 4: Доступ к Gramps Web

После развертывания приложения вы можете получить доступ к Gramps Web, нажав кнопку "Web UI" в интерфейсе приложений TrueNAS. Вы должны увидеть мастер настройки "Добро пожаловать в Gramps Web".

Если вы хотите разрешить пользователям доступ к вашему интерфейсу Gramps Web, **не** выставляйте приложение напрямую в интернет, а переходите к следующему шагу.

## Шаг 5: Настройка обратного прокси

Чтобы безопасно предоставить доступ к вашему экземпляру Gramps Web пользователям, рекомендуется настроить обратный прокси. Это позволяет управлять SSL/TLS сертификатами и контролировать доступ.

Самый простой вариант – использовать официальное приложение TrueNAS Nginx Proxy Manager. Найдите приложение в интерфейсе приложений TrueNAS и установите его. Вы можете оставить все настройки по умолчанию, но мы рекомендуем установить одну дополнительную переменную окружения: `DISABLE_IPV6` со значением `true`, чтобы избежать потенциальных проблем, связанных с IPv6.

После развертывания откройте веб-интерфейс Nginx Proxy Manager и создайте новый прокси-хост с следующими настройками:

- Схема: `http`
- Перенаправить имя хоста / IP: имя вашего сервера TrueNAS (например, `truenas`)
- Перенаправить порт: порт, назначенный вашему приложению Gramps Web (проверьте интерфейс приложений TrueNAS для точного порта)
- На вкладке "SSL" отметьте "Force SSL"
- В разделе "SSL Certificates" выберите "Add SSL Certificate" > "Let's Encrypt", чтобы создать новый сертификат Let's Encrypt для вашего домена.

Пожалуйста, смотрите [документацию Nginx Proxy Manager](https://nginxproxymanager.com/guide/) для получения дополнительных деталей о настройке вашего маршрутизатора и получении SSL сертификатов.
