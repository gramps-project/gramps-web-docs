# Налаштування сервера

Використовуючи стандартний образ Docker, всі необхідні налаштування можна зробити з браузера. Однак, в залежності від розгортання, може бути необхідно налаштувати конфігурацію сервера.

Ця сторінка містить усі методи зміни конфігурації та всі існуючі параметри конфігурації.


## Файл конфігурації проти змінних середовища

Для налаштувань ви можете використовувати або файл конфігурації, або змінні середовища.

Коли ви використовуєте [налаштування на основі Docker Compose](deployment.md), ви можете включити файл конфігурації, додавши наступний пункт списку під ключем `volumes:` в блоці `grampsweb:`:

```yaml
      - /path/to/config.cfg:/app/config/config.cfg
```
де `/path/to/config.cfg` - це шлях до файлу конфігурації у файловій системі вашого сервера (права сторона посилається на шлях у контейнері і не повинна змінюватися).

При використанні змінних середовища,

- префіксуйте кожну назву налаштування `GRAMPSWEB_`, щоб отримати назву змінної середовища
- Використовуйте подвійні підкреслення для вкладених налаштувань словника, наприклад, `GRAMPSWEB_THUMBNAIL_CACHE_CONFIG__CACHE_DEFAULT_TIMEOUT` встановить значення параметра конфігурації `THUMBNAIL_CACHE_CONFIG['CACHE_DEFAULT_TIMEOUT']`

Зверніть увагу, що параметри конфігурації, встановлені через середовище, мають пріоритет над тими, що в файлі конфігурації. Якщо обидва присутні, змінна середовища "перемагає".

## Існуючі налаштування конфігурації
Існують такі параметри конфігурації.

### Обов'язкові налаштування

Ключ | Опис
----|-------------
`TREE` | Назва бази даних родинного дерева, яку потрібно використовувати. Показати доступні дерева за допомогою `gramps -l`. Якщо дерева з цією назвою не існує, буде створено нове порожнє.
`SECRET_KEY` | Секретний ключ для Flask. Секрет не повинен бути опублікований. Зміна його анулює всі токени доступу.
`USER_DB_URI` | URL бази даних користувачів. Дозволено будь-який URL, сумісний з SQLAlchemy.

!!! info
    Ви можете згенерувати безпечний секретний ключ, наприклад, за допомогою команди

    ```
    python3 -c "import secrets;print(secrets.token_urlsafe(32))"
    ```

### Додаткові налаштування

Ключ | Опис
----|-------------
`MEDIA_BASE_DIR` | Шлях, який використовуватиметься як базовий каталог для медіафайлів, переважаючи базовий каталог медіа, встановлений у Gramps. При використанні [S3](s3.md) повинен мати форму `s3://<bucket_name>`
`SEARCH_INDEX_DB_URI` | URL бази даних для індексу пошуку. Дозволені лише `sqlite` або `postgresql` як бекенди. За замовчуванням `sqlite:///indexdir/search_index.db`, створюючи файл SQLite у папці `indexdir`, відносно шляху, де запускається скрипт
`STATIC_PATH` | Шлях для обслуговування статичних файлів (наприклад, статичний веб-фронтенд)
`BASE_URL` | Базовий URL, за яким можна отримати доступ до API (наприклад, `https://mygramps.mydomain.com/`). Це необхідно, наприклад, для створення правильних посилань для скидання паролів
`CORS_ORIGINS` | Походження, з яких дозволені запити CORS. За замовчуванням усі заборонені. Використовуйте `"*"` для дозволу запитів з будь-якого домену.
`EMAIL_HOST` | Хост SMTP сервера (наприклад, для надсилання електронних листів для скидання паролів)
`EMAIL_PORT` | Порт SMTP сервера. за замовчуванням 465
`EMAIL_HOST_USER` | Ім'я користувача SMTP сервера
`EMAIL_HOST_PASSWORD` | Пароль SMTP сервера
`EMAIL_USE_TLS` | **Застаріло** (використовуйте `EMAIL_USE_SSL` або `EMAIL_USE_STARTTLS` замість цього). Булеве значення, чи використовувати TLS для надсилання електронних листів. За замовчуванням `True`. При використанні STARTTLS встановіть це значення на `False` і використовуйте порт, відмінний від 25.
`EMAIL_USE_SSL` | Булеве значення, чи використовувати неявний SSL/TLS для SMTP (v3.6.0+). За замовчуванням `True`, якщо `EMAIL_USE_TLS` не встановлено явно. Зазвичай використовується з портом 465.
`EMAIL_USE_STARTTLS` | Булеве значення, чи використовувати явний STARTTLS для SMTP (v3.6.0+). За замовчуванням `False`. Зазвичай використовується з портом 587 або 25.
`DEFAULT_FROM_EMAIL` | Адреса "Від" для автоматизованих електронних листів
`THUMBNAIL_CACHE_CONFIG` | Словник з налаштуваннями для кешу ескізів. Дивіться [Flask-Caching](https://flask-caching.readthedocs.io/en/latest/) для можливих налаштувань.
`REQUEST_CACHE_CONFIG` | Словник з налаштуваннями для кешу запитів. Дивіться [Flask-Caching](https://flask-caching.readthedocs.io/en/latest/) для можливих налаштувань.
`PERSISTENT_CACHE_CONFIG` | Словник з налаштуваннями для постійного кешу, використовується, наприклад, для телеметрії. Дивіться [Flask-Caching](https://flask-caching.readthedocs.io/en/latest/) для можливих налаштувань.
`CELERY_CONFIG` | Налаштування для фонової черги завдань Celery. Дивіться [Celery](https://docs.celeryq.dev/en/stable/userguide/configuration.html) для можливих налаштувань.
`REPORT_DIR` | Тимчасовий каталог, де буде зберігатися вихід виконання звітів Gramps
`EXPORT_DIR` | Тимчасовий каталог, де буде зберігатися вихід експорту бази даних Gramps
`REGISTRATION_DISABLED` | Якщо `True`, заборонити реєстрацію нових користувачів (за замовчуванням `False`)
`DISABLE_TELEMETRY` | Якщо `True`, вимкнути телеметрію статистики (за замовчуванням `False`). Дивіться [телеметрія](telemetry.md) для деталей.


!!! info
    При використанні змінних середовища для конфігурації булеві параметри, такі як `EMAIL_USE_TLS`, повинні бути або рядком `true`, або `false` (регістр має значення!).


### Налаштування лише для бази даних PostgreSQL

Це необхідно, якщо ви налаштували свою базу даних Gramps для роботи з [додатком PostgreSQL](https://gramps-project.org/wiki/index.php/Addon:PostgreSQL).

Ключ | Опис
----|-------------
`POSTGRES_USER` | Ім'я користувача для підключення до бази даних
`POSTGRES_PASSWORD` | Пароль для користувача бази даних


### Налаштування, що стосуються хостингу кількох дерев

Наступні налаштування є актуальними при [хостингу кількох дерев](multi-tree.md).


Ключ | Опис
----|-------------
`MEDIA_PREFIX_TREE` | Булеве значення, чи використовувати окрему підпапку для медіафайлів кожного дерева. За замовчуванням `False`, але настійно рекомендується використовувати `True` у налаштуванні з кількома деревами
`NEW_DB_BACKEND` | Бекенд бази даних, який потрібно використовувати для новостворених родинних дерев. Повинен бути одним з `sqlite`, `postgresql` або `sharedpostgresql`. За замовчуванням `sqlite`.
`POSTGRES_HOST` | Ім'я хоста сервера PostgreSQL, що використовується для створення нових дерев при використанні налаштування з кількома деревами з бекендом SharedPostgreSQL
`POSTGRES_PORT` | Порт сервера PostgreSQL, що використовується для створення нових дерев при використанні налаштування з кількома деревами з бекендом SharedPostgreSQL


### Налаштування для аутентифікації OIDC

Ці налаштування потрібні, якщо ви хочете використовувати аутентифікацію OpenID Connect (OIDC) з зовнішніми постачальниками. Для детальних інструкцій з налаштування та прикладів дивіться [Аутентифікація OIDC](oidc.md).

Ключ | Опис
----|-------------
`OIDC_ENABLED` | Булеве значення, чи активувати аутентифікацію OIDC. За замовчуванням `False`.
`OIDC_ISSUER` | URL постачальника OIDC (для користувацьких постачальників OIDC)
`OIDC_CLIENT_ID` | ID клієнта OAuth (для користувацьких постачальників OIDC)
`OIDC_CLIENT_SECRET` | Секрет клієнта OAuth (для користувацьких постачальників OIDC)
`OIDC_NAME` | Користувацька назва для постачальника. За замовчуванням "OIDC"
`OIDC_SCOPES` | Обсяги OAuth. За замовчуванням "openid email profile"
`OIDC_USERNAME_CLAIM` | Заява, яку використовувати для імені користувача. За замовчуванням "preferred_username"
`OIDC_OPENID_CONFIG_URL` | Додатково: URL до кінцевої точки конфігурації OpenID Connect (якщо не використовується стандартний `/.well-known/openid-configuration`)
`OIDC_DISABLE_LOCAL_AUTH` | Булеве значення, чи вимкнути локальну аутентифікацію за ім'ям користувача/паролем. За замовчуванням `False`
`OIDC_AUTO_REDIRECT` | Булеве значення, чи автоматично перенаправляти на OIDC, коли налаштовано лише одного постачальника. За замовчуванням `False`

#### Вбудовані постачальники OIDC

Для вбудованих постачальників (Google, Microsoft, GitHub) використовуйте ці налаштування:

Ключ | Опис
----|-------------
`OIDC_GOOGLE_CLIENT_ID` | ID клієнта для Google OAuth
`OIDC_GOOGLE_CLIENT_SECRET` | Секрет клієнта для Google OAuth
`OIDC_MICROSOFT_CLIENT_ID` | ID клієнта для Microsoft OAuth
`OIDC_MICROSOFT_CLIENT_SECRET` | Секрет клієнта для Microsoft OAuth
`OIDC_GITHUB_CLIENT_ID` | ID клієнта для GitHub OAuth
`OIDC_GITHUB_CLIENT_SECRET` | Секрет клієнта для GitHub OAuth

#### Відображення ролей OIDC

Ці налаштування дозволяють вам відображати групи/ролі OIDC з вашого постачальника ідентичності на ролі користувачів Gramps Web:

Ключ | Опис
----|-------------
`OIDC_ROLE_CLAIM` | Назва заяви в токені OIDC, що містить групи/ролі користувача. За замовчуванням "groups"
`OIDC_GROUP_ADMIN` | Назва групи/ролі з вашого постачальника OIDC, яка відповідає ролі "Admin" у Gramps
`OIDC_GROUP_OWNER` | Назва групи/ролі з вашого постачальника OIDC, яка відповідає ролі "Owner" у Gramps
`OIDC_GROUP_EDITOR` | Назва групи/ролі з вашого постачальника OIDC, яка відповідає ролі "Editor" у Gramps
`OIDC_GROUP_CONTRIBUTOR` | Назва групи/ролі з вашого постачальника OIDC, яка відповідає ролі "Contributor" у Gramps
`OIDC_GROUP_MEMBER` | Назва групи/ролі з вашого постачальника OIDC, яка відповідає ролі "Member" у Gramps
`OIDC_GROUP_GUEST` | Назва групи/ролі з вашого постачальника OIDC, яка відповідає ролі "Guest" у Gramps

### Налаштування лише для функцій AI

Ці налаштування потрібні, якщо ви хочете використовувати функції на основі AI, такі як чат або семантичний пошук.

Ключ | Опис
----|-------------
`LLM_BASE_URL` | Базовий URL для API чату, сумісного з OpenAI. За замовчуванням `None`, що використовує API OpenAI.
`LLM_MODEL` | Модель, яку потрібно використовувати для API чату, сумісного з OpenAI. Якщо не встановлено (за замовчуванням), чат вимкнено. Починаючи з версії 3.6.0, AI асистент використовує Pydantic AI з можливостями виклику інструментів.
`VECTOR_EMBEDDING_MODEL` | Модель [Sentence Transformers](https://sbert.net/), яку потрібно використовувати для семантичного пошуку векторних вбудувань. Якщо не встановлено (за замовчуванням), семантичний пошук і чат вимкнено.
`LLM_MAX_CONTEXT_LENGTH` | Обмеження символів для контексту родинного дерева, наданого LLM. За замовчуванням 50000.
`LLM_SYSTEM_PROMPT` | Користувацький системний запит для асистента чату LLM (v3.6.0+). Якщо не встановлено, використовується стандартний запит, оптимізований для генеалогії.


## Приклад файлу конфігурації

Мінімальний файл конфігурації для виробництва може виглядати так:
```python
TREE="My Family Tree"
BASE_URL="https://mytree.example.com"
SECRET_KEY="..."  # ваш секретний ключ
USER_DB_URI="sqlite:////path/to/users.sqlite"
EMAIL_HOST="mail.example.com"
EMAIL_PORT=465
EMAIL_USE_SSL=True  # Використовуйте неявний SSL для порту 465
EMAIL_HOST_USER="gramps@example.com"
EMAIL_HOST_PASSWORD="..." # ваш SMTP пароль
DEFAULT_FROM_EMAIL="gramps@example.com"
